-- =========================================================
-- LIZ HUB (VERSION 2.8.0 - INF TOWER FIX)
-- PART 1: SETUP
-- =========================================================

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()
local HttpService = game:GetService("HttpService")

local Window = Fluent:CreateWindow({
    Title = "Liz HUB",
    SubTitle = "Inf Tower Fixed",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 520),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

-- VARIABLES
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer
local Remote = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Signal"):WaitForChild("RemoteEvent")

-- Remote Paths
local DungeonRemotePath = ReplicatedStorage:WaitForChild("NEW37"):WaitForChild("DUNGEONS"):WaitForChild("DungeonEvent")
local ItemRemote = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("ItemRemote")

-- CONFIG
local Config = {
    AutoDungeon = false,
    AutoTower = false, -- [UPDATED LOGIC]
    SelectedDungeonRank = "B",
    
    AutoFarm = false,
    AuraKill = false,
    
    AutoMadara = false,
    AutoItachi = false,
    AutoUseDB = false,
    
    SkillDelay = 0,
    OffVFX = false,
    ReduceLag = false,
    AntiAFK = false,
    
    HoverHeight = 12,
    SelectedTP = "Broly"
}

-- DATA
local DungeonData = {
    ["B"] = { Name = "B Dungeon Ticket", Var = "BDTickets" },
    ["A"] = { Name = "A Dungeon Ticket", Var = "ADTickets" },
    ["S"] = { Name = "S Dungeon Ticket", Var = "SDTickets" },
    ["SS"] = { Name = "SS Dungeon Ticket", Var = "SSDTickets" }
}

local TeleportData = {
    ["Broly"] = { TargetName = "Legendary Saiyan6", Coords = CFrame.new(1402, -3, 143) },
    ["Tanjiro"] = { TargetName = "Tanjiro", Coords = CFrame.new(1510, 17, -104) },
    ["Prestige NPC"] = { TargetName = "PrestigeNPC", Coords = CFrame.new(611, 222, 833) },
    ["Sukuna"] = { TargetName = "Sukuna", Coords = CFrame.new(870, 122, 526) },
    ["Zoro"] = { TargetName = "Zoro (PTS)", Coords = CFrame.new(557, 5, -182) },
    ["Cell"] = { TargetName = "Cell", Coords = CFrame.new(1094, 21, -912) },
    ["Shop"] = { TargetName = "Shop", Coords = CFrame.new(-829, 9, -1087) }
}

-- TABS
local Tabs = {
    Main = Window:AddTab({ Title = "Auto Dungeon", Icon = "castle" }),
    Farm = Window:AddTab({ Title = "Auto Farm", Icon = "sword" }),
    Teleport = Window:AddTab({ Title = "Teleport", Icon = "map" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "component" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- FUNCTIONS
function ToggleAntiGravity(state)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    if state then
        if not char.HumanoidRootPart:FindFirstChild("JemAntiGravity") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "JemAntiGravity"
            bv.Velocity = Vector3.new(0,0,0)
            bv.MaxForce = Vector3.new(1e5,1e5,1e5)
            bv.Parent = char.HumanoidRootPart
        end
    else
        local bv = char.HumanoidRootPart:FindFirstChild("JemAntiGravity")
        if bv then bv:Destroy() end
    end
end

local function LookAtTarget(targetPart)
    if not targetPart then return end
    local cam = Workspace.CurrentCamera
    cam.CFrame = CFrame.new(cam.CFrame.Position, targetPart.Position)
end

local function GetPartyID()
    local reiNew = LocalPlayer:FindFirstChild("ReiNew")
    if reiNew then
        for _, v in pairs(reiNew:GetChildren()) do
            if v:IsA("StringValue") and (v.Name:lower():match("party") or v.Name:lower():match("id")) then
                if #v.Value > 10 then return v.Value end
            end
        end
    end
    local pv = LocalPlayer:FindFirstChild("PlayerValues")
    if pv then
        local party = pv:FindFirstChild("PartyID") or pv:FindFirstChild("SquadID")
        if party then return party.Value end
    end
    return nil 
end
-- =========================================================
-- LIZ HUB (VERSION 2.11.0 - CLEAN SWEEP LOGIC)
-- PART 2: LOOPS & UI
-- =========================================================

-- Loop 1: System (Lag/VFX)
task.spawn(function()
    while true do
        if Config.ReduceLag then
            pcall(function() for _, g in pairs(LocalPlayer.PlayerGui:GetChildren()) do if g.Name:lower():match("damage") or g.Name:lower():match("indicator") then g.Enabled = false end end end)
        else
            pcall(function() for _, g in pairs(LocalPlayer.PlayerGui:GetChildren()) do if g.Name:lower():match("damage") then g.Enabled = true end end end)
        end
        if Config.OffVFX then
            pcall(function() if LocalPlayer.Backpack:FindFirstChild("Scripts") then LocalPlayer.Backpack.Scripts.NewModules:Destroy() end end)
            for _, o in pairs(Workspace:GetChildren()) do if o.Name:match("HitPart") or o.Name:match("Splash") then o:Destroy() end end
            for _, n in pairs({"Particles", "NewEffects", "KevSFX", "VFX", "ReiNew"}) do if ReplicatedStorage:FindFirstChild(n) then ReplicatedStorage[n]:Destroy() end end
        end
        task.wait(1)
    end
end)

-- Loop 2: Combat (Attack & Skills)
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        -- Auto Skills
        if Config.AutoMadara then ReplicatedStorage.Remotes.AbilityHandler:FireServer("MadaraFifth") end
        if Config.AutoItachi and char and char:FindFirstChild("HumanoidRootPart") then 
            ReplicatedStorage.RemoteEvents.ItachiSusanooRibcageRemote:FireServer(false, char.HumanoidRootPart.Position, char.HumanoidRootPart.CFrame, 1) 
        end
        
        -- Aura Kill (ทำงานตลอดเวลาถ้าเปิด)
        if Config.AuraKill then 
            ReplicatedStorage.RemoteEvents.BladeCombatRemote:FireServer() 
        end
        
        task.wait(Config.SkillDelay > 0 and Config.SkillDelay or 0.1)
    end
end)

-- Loop 3: Auto Use DB
task.spawn(function()
    while true do
        if Config.AutoUseDB then
            local bp = LocalPlayer:FindFirstChild("Backpack")
            if bp then 
                for _, item in pairs(bp:GetChildren()) do 
                    if item.Name:lower():match("dragonball") then 
                        pcall(function() ItemRemote:FireServer(item.Name) end) 
                    end 
                end 
            end
        end
        task.wait(1)
    end
end)

-- Loop 4: MAIN LOGIC (Farm/Dungeon/Tower)
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        
        if hrp then
            -- [[ MODE: AUTO DUNGEON ]]
            if Config.AutoDungeon then
                if not Workspace:FindFirstChild("Floors") then
                    local selected = DungeonData[Config.SelectedDungeonRank]
                    if selected and LocalPlayer.ReiNew[selected.Var].Value > 0 then
                        local dr = ReplicatedStorage:FindFirstChild("NEW37"):FindFirstChild("DUNGEONS"):FindFirstChild("DungeonEvent")
                        if dr then
                            dr:FireServer("Use Dungeon Ticket", { selected.Name, selected.Var })
                            task.wait(1.5)
                            dr:FireServer("Start Dungeon")
                            task.wait(5)
                        end
                    end
                else
                    -- Dungeon Logic (ใช้ Logic เดียวกับ Tower ก็ได้ หรือจะแยกก็ได้)
                    -- เบื้องต้นให้ Auto Farm ทำงานในนี้แทน
                end

            -- [[ MODE: AUTO INF TOWER (Clean Sweep -> Next) ]]
            elseif Config.AutoTower then
                ToggleAntiGravity(true)
                
                -- 1. เช็คว่าอยู่ในเกมหรือยัง (มี Folder Floors มั้ย)
                if not Workspace:FindFirstChild("Floors") then
                    -- LOBBY: วาร์ปหา NPC DeathTapz
                    local npc = Workspace.NPCS:FindFirstChild("DeathTapz")
                    if npc then
                        hrp.CFrame = npc.HumanoidRootPart.CFrame * CFrame.new(0, 0, 3)
                        LookAtTarget(npc.HumanoidRootPart)
                        task.wait(0.5)
                        -- กดคุย (รอคนกด Start เอง)
                        for _, v in pairs(npc:GetDescendants()) do 
                            if v:IsA("ProximityPrompt") then fireproximityprompt(v) end 
                        end
                        task.wait(2)
                    end
                else
                    -- IN GAME:
                    
                    -- STEP 1: หา MOBS ใน Workspace.Live
                    local liveFolder = Workspace:FindFirstChild("Live")
                    local targetMob = nil
                    
                    if liveFolder then
                        -- หาตัวที่ใกล้ที่สุด
                        local closestDist = 9999
                        for _, mob in pairs(liveFolder:GetChildren()) do
                            if mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 and mob:FindFirstChild("HumanoidRootPart") then
                                local dist = (mob.HumanoidRootPart.Position - hrp.Position).Magnitude
                                if dist < closestDist then
                                    closestDist = dist
                                    targetMob = mob
                                end
                            end
                        end
                    end
                    
                    if targetMob then
                        -- [KILL PHASE] เจอศัตรู -> ฆ่าแม่งให้หมด!
                        local tPos = targetMob.HumanoidRootPart.Position
                        -- วาร์ปไปเหนือหัวมอน
                        hrp.CFrame = CFrame.new(tPos + Vector3.new(0, Config.HoverHeight, 0), tPos)
                    else
                        -- [NEXT PHASE] ศัตรูหมดแมพ -> ไปชั้นต่อไป
                        local floor0 = Workspace.Floors:FindFirstChild("0")
                        
                        -- หา NPC หรือจุดวาร์ป
                        local targetCFrame = nil
                        if floor0 and floor0:FindFirstChild("NPC") then
                             targetCFrame = floor0.NPC.CFrame -- ใช้ตำแหน่ง NPC เป๊ะๆ
                        else
                             targetCFrame = CFrame.new(495, 15, -73) -- พิกัดสำรอง
                        end
                        
                        if targetCFrame then
                            hrp.CFrame = targetCFrame
                        end
                        
                        -- รัวปุ่ม E
                        task.wait(0.1)
                        for _, prompt in pairs(Workspace:GetDescendants()) do
                            if prompt:IsA("ProximityPrompt") and prompt.Enabled and prompt.Parent then
                                if (hrp.Position - prompt.Parent.Position).Magnitude < 20 then
                                    if fireproximityprompt then
                                        fireproximityprompt(prompt)
                                    else
                                        prompt:InputHoldBegin()
                                        task.wait(prompt.HoldDuration + 0.1)
                                        prompt:InputHoldEnd()
                                    end
                                end
                            end
                        end
                        task.wait(0.5)
                    end
                end

            -- [[ MODE: AUTO FARM ALL MOB (Lobby/Overworld) ]]
            elseif Config.AutoFarm then
                ToggleAntiGravity(true)
                
                -- STEP 1: หา MOBS ใน Workspace.Live อย่างเดียว (ไม่สนใจ NPC/Prompt)
                local liveFolder = Workspace:FindFirstChild("Live")
                local targetMob = nil
                
                if liveFolder then
                    local closestDist = 9999
                    for _, mob in pairs(liveFolder:GetChildren()) do
                        if mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 and mob:FindFirstChild("HumanoidRootPart") then
                            local dist = (mob.HumanoidRootPart.Position - hrp.Position).Magnitude
                            if dist < closestDist then
                                closestDist = dist
                                targetMob = mob
                            end
                        end
                    end
                end
                
                if targetMob then
                    -- เจอ -> วาร์ปไปตบ
                    local tPos = targetMob.HumanoidRootPart.Position
                    hrp.CFrame = CFrame.new(tPos + Vector3.new(0, Config.HoverHeight, 0), tPos)
                else
                    -- ไม่เจอ -> ลอยนิ่งๆ รอเกิด (ไม่ต้องวาร์ปไปหา NPC)
                    -- อาจจะใส่วาร์ปไปจุดกลางแมพ หรือจุดฟาร์มประจำก็ได้ถ้าต้องการ
                end

            else
                -- ปิดทุกโหมด
                ToggleAntiGravity(false)
            end
        end
        task.wait() -- Loop Speed
    end
end)

-- UI SETUP
local SectionDungeon = Tabs.Main:AddSection("Dungeon Settings")
Tabs.Main:AddDropdown("RankSelect", {Title="Select Dungeon Rank", Values={"B","A","S","SS"}, Default=1, Callback=function(V) Config.SelectedDungeonRank=V end})
Tabs.Main:AddToggle("AutoDungeonToggle", {Title="Auto Dungeon", Default=false, Callback=function(V) Config.AutoDungeon=V end})

local SectionTower = Tabs.Main:AddSection("Infinity Tower")
Tabs.Main:AddToggle("AutoTowerToggle", {Title="Auto Inf Tower (Clear -> Next)", Default=false, Callback=function(V) Config.AutoTower=V end})

local SectionItem = Tabs.Main:AddSection("Item Management")
Tabs.Main:AddToggle("AutoUseDBToggle", {Title="Auto Use Dragonball", Default=false, Callback=function(V) Config.AutoUseDB=V end})

local SectionFarm = Tabs.Farm:AddSection("Attack & Skills")
Tabs.Farm:AddToggle("AuraKillToggle", {Title="Aura Kill", Default=false, Callback=function(V) Config.AuraKill=V end})
Tabs.Farm:AddToggle("AutoMadaraToggle", {Title="Auto Madara", Default=false, Callback=function(V) Config.AutoMadara=V end})
Tabs.Farm:AddToggle("AutoItachiToggle", {Title="Auto Itachi", Default=false, Callback=function(V) Config.AutoItachi=V end})
Tabs.Farm:AddSlider("SkillSpeedSlider", {Title="Spam Delay", Default=0, Min=0, Max=1, Rounding=2, Callback=function(V) Config.SkillDelay=V end})
Tabs.Farm:AddToggle("AutoFarmToggle", {Title="Auto Farm All Mob (No Interact)", Default=false, Callback=function(V) Config.AutoFarm=V end})

local SectionTP = Tabs.Teleport:AddSection("Waypoints")
Tabs.Teleport:AddDropdown("TPSelect", {Title="Destination", Values={"Broly","Tanjiro","Prestige NPC","Sukuna","Zoro","Cell","Shop"}, Default=1, Callback=function(V) Config.SelectedTP=V end})
Tabs.Teleport:AddButton({Title="Teleport Now", Callback=function() local d=TeleportData[Config.SelectedTP]; local t=Workspace.ChatParts:FindFirstChild(d.TargetName) or Workspace.Live:FindFirstChild(d.TargetName); if t then LocalPlayer.Character.HumanoidRootPart.CFrame=(t:IsA("Model") and t.HumanoidRootPart.CFrame or t.CFrame) else LocalPlayer.Character.HumanoidRootPart.CFrame=d.Coords end end})

local SectionMisc = Tabs.Misc:AddSection("Miscellaneous")
Tabs.Misc:AddToggle("AntiAFKToggle", {Title="Anti AFK", Default=false, Callback=function(V) Config.AntiAFK=V; if V then LocalPlayer.Idled:Connect(function() if Config.AntiAFK then VirtualUser:CaptureController(); VirtualUser:ClickButton2(Vector2.new()) end end) end end})
Tabs.Misc:AddToggle("OffVFXToggle", {Title="Off VFX", Default=false, Callback=function(V) Config.OffVFX=V end})
Tabs.Misc:AddToggle("ReduceLagToggle", {Title="Reduce Lag", Default=false, Callback=function(V) Config.ReduceLag=V end})

SaveManager:SetLibrary(Fluent); InterfaceManager:SetLibrary(Fluent); SaveManager:IgnoreThemeSettings(); SaveManager:SetIgnoreIndexes({}); SaveManager:BuildConfigSection(Tabs.Settings); InterfaceManager:BuildInterfaceSection(Tabs.Settings)
Window:SelectTab(1); SaveManager:LoadAutoloadConfig()
Fluent:Notify({Title="Liz HUB", Content="Clean Sweep Logic Loaded!", Duration=5})
